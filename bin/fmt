#!/usr/bin/env bash
#/ Usage: bin/fmt [-c|--check]
#/ Description: Formats all C# files in the Unity package and tests.
#/ Options:
#/   -c, --check - Run in check mode. Will return a non-zero exit code if anything needs reformatting.
source bin/helpers/_utils.sh
set_source_and_root_dir

PACKAGE_DIR="./com.posthog.unity"
TESTS_DIR="./tests"

check=false

while (( "$#" )); do
    key="$1"
    shift
    case "$key" in
        -c|--check)
            check=true
            ;;
        -\?|-h|--help)
            grep '^#/' <"$0" | cut -c4-
            exit
        ;;
    esac
done

if $check; then
    echo "Running in check mode: Will return a non-zero exit code if anything needs reformatting."
else
    echo "Running in reformat mode: Will automatically reformat files if they need reformatting."
fi

success=true

# Ensure dotnet is available
if ! type dotnet >/dev/null 2>&1; then
    echo ".NET CLI is not installed!" 1>&2
    exit 1
fi

# Check if dotnet-csharpier is installed, install if not
if ! dotnet tool list -g | grep -q csharpier; then
    echo "Installing CSharpier..."
    dotnet tool install -g csharpier
fi

# Add .NET tools to PATH
export PATH="$PATH:$HOME/.dotnet/tools"

# Step 1: Run dotnet format for code style fixes (e.g., file-scoped namespaces)
# This uses the formatting-only project that references all Unity package source files
FORMAT_PROJECT="./PostHog.Unity.Format.csproj"

echo "Running dotnet format style on $FORMAT_PROJECT..."

if $check; then
    if ! dotnet format style "$FORMAT_PROJECT" --severity warn --verify-no-changes --verbosity quiet; then
        echo "Code style check failed. Run 'bin/fmt' to fix."
        success=false
    fi
else
    if ! dotnet format style "$FORMAT_PROJECT" --severity warn --verbosity quiet; then
        echo "dotnet format style failed!" 1>&2
        success=false
    fi
fi

# Step 2: Run CSharpier for whitespace formatting
echo "Running CSharpier on $PACKAGE_DIR and $TESTS_DIR..."

if $check; then
    if ! csharpier check "$PACKAGE_DIR" "$TESTS_DIR"; then
        success=false
    fi
else
    if ! csharpier format "$PACKAGE_DIR" "$TESTS_DIR"; then
        success=false
    fi
fi

if $success; then
    echo "You're all good!"
else
    echo "Formatting is no good! Run 'bin/fmt' to fix" 1>&2
    exit 1
fi
