#!/usr/bin/env bash
#/ Usage: bin/generate-version
#/ Description: Generates SdkInfo.Generated.cs from package.json version.
set -euo pipefail
source bin/helpers/_utils.sh
set_source_and_root_dir

PACKAGE_JSON="com.posthog.unity/package.json"
VERSION_FILE="com.posthog.unity/Runtime/Utilities/SdkInfo.Generated.cs"

if ! command -v jq &> /dev/null; then
    fatal "jq is required but not installed. Run bin/bootstrap to install dependencies."
fi

if [[ ! -f "$PACKAGE_JSON" ]]; then
    fatal "package.json not found at $PACKAGE_JSON"
fi

version=$(jq -r '.version' "$PACKAGE_JSON")
if [[ -z "$version" || "$version" == "null" ]]; then
    fatal "Could not read version from $PACKAGE_JSON"
fi

cat > "$VERSION_FILE" << EOF
// <auto-generated>
// This file is generated by bin/generate-version from package.json.
// Do not edit manually.
// </auto-generated>

namespace PostHog
{
    static partial class SdkInfo
    {
        /// <summary>
        /// The current SDK version.
        /// </summary>
        public const string Version = "$version";
    }
}
EOF

echo "Generated $VERSION_FILE with version $version"
